---
title: 'Investment Simulation #1'
author: "Geirmundur Orri Sigurdsson"
date: '2023-01-18'
output: html_document
params:
  end_date: 2020-01-01
  year_count: 4
  buy_per_year: 12
  voo_buy_budget: 600
  nov_buy_budget: 0
  nasdx_buy_budget: 200
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Dependencies

```{r dependencies, message=FALSE, warning=FALSE}
library(quantmod)
library(tidyverse)
library(lubridate)
library(xts)
```

# Option

```{r option}
# Buy count
buy_count = params$year_count * params$buy_per_year

# Data Range
edate <- as.Date(params$end_date, optional = TRUE)
if (is.na(edate)) { edate <- Sys.Date() }
sdate <- edate - years(params$year_count)
```

# Fetch Data

```{r fetch}
voo_stock <- getSymbols('voo', from=sdate, to=edate, auto.assign=F)
nov_stock <- getSymbols('nov', from=sdate, to=edate, auto.assign=F)
nasdx_stock <- getSymbols('nasdx', from=sdate, to=edate, auto.assign=F)
```

# Wrangling

```{r wrangling}
# Typically use previous value for NA
no.na <- which(is.na(voo_stock[,6]))      # no for NA
voo_stock[no.na,6] <- voo_stock[no.na-1,6]
no.na <- which(is.na(nov_stock[,6]))      # no for NA
nov_stock[no.na,6] <- nov_stock[no.na-1,6]
no.na <- which(is.na(nasdx_stock[,6]))
nasdx_stock[no.na,6] <- nasdx_stock[no.na-1,6]

# Only stock price
voo_price <- voo_stock[,6]
nov_price <- nov_stock[,6]
nasdx_price <- nasdx_stock[,6]

voo <- fortify.zoo(voo_price)
voo <- voo %>% mutate(date=Index, tag='VOO', value=VOO.Adjusted) %>% select(date, tag, value)
nov <- fortify.zoo(nov_price)
nov <- nov %>% mutate(date=Index, tag='NOV', value=NOV.Adjusted) %>% select(date, tag, value)
nasdx <- fortify.zoo(nasdx_price)
nasdx <- nasdx %>% mutate(date=Index, tag='NASDX', value=NASDX.Adjusted) %>% select(date, tag, value)
```

# Checking and Extracting

```{r checking}
count <- nrow(voo)
stopifnot(count == nrow(nov))
stopifnot(count == nrow(nasdx))

buy_space <- count / buy_count

voo_last <- voo$value[nrow(voo)]
nov_last <- nov$value[nrow(nov)]
nasdx_last <- nasdx$value[nrow(nasdx)]
```

# Simulate

```{r simulate}
index <- 1
total_buy <- 0
buy <- data.frame(date=as.Date(character()), tag=character(), price=as.numeric(character()), shares=as.numeric(character()), sell=as.numeric(character()), profit=as.numeric(character()))
while(index < count) {
  by <- nrow(buy) + 1
  buy[by, 1] = voo$date[index]
  buy[by, 2] = voo$tag[index]
  buy[by, 3] = voo$value[index]
  buy[by, 4] = params$voo_buy_budget / voo$value[index]
  buy[by, 5] = voo_last * params$voo_buy_budget / voo$value[index]
  buy[by, 6] = (voo_last * params$voo_buy_budget / voo$value[index]) - params$voo_buy_budget
  total_buy <- total_buy + params$voo_buy_budget
  by <- nrow(buy) + 1
  buy[by, 1] = nov$date[index]
  buy[by, 2] = nov$tag[index]
  buy[by, 3] = nov$value[index]
  buy[by, 4] = params$nov_buy_budget / nov$value[index]
  buy[by, 5] = nov_last * params$nov_buy_budget / nov$value[index]
  buy[by, 6] = (nov_last * params$nov_buy_budget / nov$value[index]) - params$nov_buy_budget
  total_buy <- total_buy + params$nov_buy_budget
  by <- nrow(buy) + 1
  buy[by, 1] = nasdx$date[index]
  buy[by, 2] = nasdx$tag[index]
  buy[by, 3] = nasdx$value[index]
  buy[by, 4] = params$nasdx_buy_budget / nasdx$value[index]
  buy[by, 5] = nasdx_last * params$nasdx_buy_budget / nasdx$value[index]
  buy[by, 6] = (nasdx_last * params$nasdx_buy_budget / nasdx$value[index]) - params$nasdx_buy_budget
  total_buy <- total_buy + params$nasdx_buy_budget
  index <- index + buy_space
}
total_profit <- sum(buy$profit)
total_profit_per_year <- total_profit / params$year_count
profit_ratio <- total_profit / total_buy
profit_ratio_per_year <- total_profit_per_year / total_buy
```

# Visualisation

```{r visualisation, warning=FALSE}
ggplot(data = buy, mapping = aes(x = date, y = profit, color = tag)) + geom_line()
```

# Results

Totally invested is $`r toString(total_buy)`. Total profit is $`r toString(round(total_profit, digits = 0))`. Profit ratio is `r toString(round(100*profit_ratio, digits = 2))`%. Profit per year is $`r toString(round(total_profit_per_year, digits = 0))`. Amount after selling is $`r toString(total_buy + round(total_profit, digits = 0))`.
